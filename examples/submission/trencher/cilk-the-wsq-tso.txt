#
# A model of the work-stealing queue from Cilk 5, as presented in
#
# Matteo Frigo, Charles E. Leiserson, and Keith H. Randall. The implementation
# of the cilk-5 multithreaded language. SIGPLAN Not., 33(5):212–223, May 1998.
# 
# This program needs 2 fences to be SC.
#
# Memory layout:
# 0 — H
# 1 — T
# 2 — L

thread worker
initial t00
 
transition	t00	t001	local	limit	0
transition	t001	t002	write	10	0
transition	t002	t0_0	write	10	1
transition	t0_0	t0_1	check	<	limit	10
transition	t0_1	t0	local	limit	+	limit	1
transition 	t0 	pop0	noop
transition 	t0 	push0	noop


transition	pop0	pop1	read	T	1
transition	pop1	pop2_0	write	- T  1	1
transition	pop2_0	pop2	mfence

transition	pop2	pop3	read	T	1
transition	pop3	pop4	read	H	0
transition	pop4	success	check	<= H T
transition	pop4	pop5	check	> H T

transition	pop5	pop6	read	T	1
transition	pop6	pop7	write	+ T  1	1

transition	pop7	pop71	lock
transition	pop71	pop72	read	L	2
transition	pop72	pop73	check	==  L 	0
transition	pop73	pop74	write	1	2
transition	pop74	pop8	unlock


transition	pop8	pop9	read	T	1
transition	pop9	pop10	write	- T  1	1

transition	pop10	pop11	read	H	0
transition	pop11	pop111	read	T	1
transition	pop111	pop12	check	<= H T
transition	pop111	pop13	check	> H T

transition	pop12	success	write	0	2

transition	pop13	pop14	read	T	1
transition	pop14	pop15	write	+ T 1	1

transition	pop15	failure	write	0	2

transition	push0	push1	read	T	1
transition	push1	push2	write	+ T 1	1

transition	push2	t0_0 	noop
transition	success	t0_0 	noop
transition	failure	t0_0 	noop

end


thread steal
initial steal00

transition	steal00	steal000	read	H	0
transition	steal000	steal001	read	T	1
transition	steal001	steal0	check && == H 10 == T 10

transition	steal0	steal01	lock
transition	steal01	steal02	read	L	2
transition	steal02	steal03	check	==  L 	0
transition	steal03	steal04	write	1	2
transition	steal04	steal1	unlock

transition	steal1	steal2	read	H	0

transition	steal2	steal3_0	write	+ H 1	0
transition	steal3_0	steal3	mfence

transition	steal3	steal4	read	H	0
transition	steal4	steal5	read	T	1
transition	steal5	steal6	check	<= H T
transition	steal5	steal7	check	> H T

transition	steal6	success	write	0	2

transition	steal7	steal8	read	H	0
transition	steal8	steal9	write	- H 1	0

transition	steal9	failure	write	0	2

transition	success t0	noop
transition	failure t0	noop

transition	t0	steal0	noop

end
